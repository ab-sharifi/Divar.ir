{% extends "user/user-base.html" %} 

{% block title %} صفحه کاربری {% endblock %}

{% block navbar %}
<nav class="navbar d-flex bg-light p-0 m-0">
  <a href="{{url_for('index')}}" class="navbar-brand">
    <img
      style="width: 50px"
      class="navbar-icon-user-profile"
      src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik04LjM4NTUzIDE0LjYxNzNIOC4yODA0M0M3Ljg5NTA2IDE0LjU2NDcgNy42MzIzMiAxNC4xOTY5IDcuNjg0ODcgMTMuODExNUM4LjE1NzgxIDEwLjY5MzYgOC4zMTU0NiA1LjcxODg3IDguMzE1NDYgNS42ODM4NEM4LjM1MDQ5IDUuMjk4NDggOC42NDgyNyA0Ljk4MzE4IDkuMDUxMTUgNS4wMDA3QzkuNDM2NTIgNS4wMTgyMSA5LjczNDMgNS4zMzM1MSA5LjczNDMgNS43MTg4N0M5LjczNDMgNS45MjkwNyA5LjU1OTEzIDEwLjgxNjIgOS4wODYxOSAxNC4wMjE3QzkuMDMzNjQgMTQuMzcyIDguNzM1ODYgMTQuNjE3MyA4LjM4NTUzIDE0LjYxNzNaTTE4LjQyMjUgMTUuOTEzNUMxOC4xMjQ3IDE1LjkxMzUgMTcuODQ0NCAxNS43MjA4IDE3Ljc1NjkgMTUuNDIzQzE3LjYzNDIgMTUuMDU1MiAxNy44NDQ0IDE0LjY1MjMgMTguMjEyMyAxNC41NDcyQzIxLjUyMjkgMTMuNDk2MiAyMS41NzU0IDEyLjY5MDQgMjEuNTkzIDEyLjI1MjVDMjEuNjI4IDExLjU2OTQgMjEuMTAyNSAxMC42OTM2IDIwLjg5MjMgMTAuMzk1OEMyMC42NjQ2IDEwLjA4MDUgMjAuNzM0NyA5LjY0MjU3IDIxLjA1IDkuNDE0ODVDMjEuMzY1MiA5LjE4NzE0IDIxLjgwMzIgOS4yNTcyIDIyLjAzMDkgOS41NzI1QzIyLjEzNiA5LjcxMjYzIDIzLjA4MTkgMTEuMDI2NCAyMi45OTQzIDEyLjM0MDFDMjIuOTA2NyAxMy45MzQxIDIxLjY4MDUgMTQuOTE1IDE4LjYzMjcgMTUuODk2QzE4LjU5NzYgMTUuODk2IDE4LjU2MjYgMTUuOTAwMyAxOC41Mjc2IDE1LjkwNDdDMTguNDkyNSAxNS45MDkxIDE4LjQ1NzUgMTUuOTEzNSAxOC40MjI1IDE1LjkxMzVaTTguOTExMDIgMTguMzgzM0M4LjcwMDgyIDE4LjM4MzMgOC40OTA2MyAxOC4yOTU3IDguMzY4MDEgMTguMTIwNkM4LjEyMjc4IDE3LjgyMjggOC4xNzUzMyAxNy4zNjczIDguNDkwNjMgMTcuMTM5NkM5LjkyNjk4IDE2LjAwMTEgMTAuODkwNCAxNC45ODUxIDExLjUyMSAxNC4wOTE4QzExLjE3MDYgMTMuOTE2NiAxMC44MDI4IDEzLjY1MzggMTAuNjEwMSAxMy4yMTU5QzEwLjQzNSAxMi44MTMxIDEwLjMyOTkgMTIuMTQ3NCAxMC45NDI5IDExLjI1NDFDMTEuODE4OCA5Ljk1Nzg2IDEyLjY5NDYgOS42NjAwOCAxMy4wMjc0IDkuNTkwMDJDMTMuNDgyOCA5LjUwMjQ0IDEzLjkyMDcgOS43NjUxOCAxNC4wNDM0IDEwLjIwMzFDMTQuMTMwOSAxMC41MTg0IDE0LjM0MTEgMTEuNTE2OCAxMy43MTA1IDEzLjA0MDhDMTQuNTUxMyAxMy4wMjMzIDE1LjIxNyAxMi43OTU1IDE1LjcyNDkgMTIuMzc1MUMxNi43MDU5IDExLjU4NjkgMTYuNzU4NCAxMC4yNTU2IDE2Ljc1ODQgMTAuMjM4MUMxNi43NzU5IDkuODUyNzcgMTcuMDkxMiA5LjU1NDk4IDE3LjQ3NjYgOS41NTQ5OEMxNy44NjE5IDkuNTcyNSAxOC4xNTk3IDkuODg3OCAxOC4xNTk3IDEwLjI3MzJDMTguMTU5NyAxMC4zNDMyIDE4LjA4OTcgMTIuMjE3NSAxNi42MzU4IDEzLjQ0MzZDMTUuNzI0OSAxNC4yMTQ0IDE0LjQ4MTMgMTQuNTQ3MiAxMi45NzQ4IDE0LjQyNDZDMTIuMjU2NyAxNS41MjgxIDExLjExODEgMTYuODI0MyA5LjM0ODkzIDE4LjIyNTZDOS4yMDg4IDE4LjMzMDcgOS4wNjg2NyAxOC4zODMzIDguOTExMDIgMTguMzgzM1pNMTIuNzEyMSAxMS4zMDY2QzEyLjUxOTQgMTEuNDY0MyAxMi4zMDkyIDExLjY5MiAxMi4wODE1IDEyLjA0MjNDMTEuODUzOCAxMi4zOTI3IDExLjgzNjMgMTIuNTg1MyAxMS44NTM4IDEyLjYzNzlDMTEuODg4OCAxMi43MjU1IDEyLjA2NCAxMi44MTMxIDEyLjIzOTIgMTIuODgzMUMxMi41NzIgMTIuMjE3NSAxMi42NzcxIDExLjY5MiAxMi43MTIxIDExLjMwNjZaTTEyLjg4NzMgMTYuMjI4OEMxMi45MDQ4IDE2LjYxNDEgMTMuMjIwMSAxNi45MTE5IDEzLjU4NzkgMTYuOTExOUgxMy42MjNDMTMuNjc1NSAxNi45MTE5IDE0Ljg0OTEgMTYuODc2OSAxNi41MzA3IDE2LjQ5MTVDMTYuOTE2MSAxNi40MDM5IDE3LjE2MTMgMTYuMDM2MSAxNy4wNzM3IDE1LjY1MDdDMTYuOTg2MSAxNS4yNjU0IDE2LjYxODMgMTUuMDIwMSAxNi4yMzI5IDE1LjEwNzdDMTQuNjczOSAxNS40NDA1IDEzLjU3MDQgMTUuNDkzMSAxMy41NTI5IDE1LjQ5MzFDMTMuMTY3NSAxNS41MTA2IDEyLjg2OTcgMTUuODQzNCAxMi44ODczIDE2LjIyODhaTTEuMTMzNyAxOC4xMDNDMS4yNTYzMSAxOC4yNzgyIDEuNDg0MDMgMTguMzgzMyAxLjY5NDIzIDE4LjM4MzNDMS44MzQzNiAxOC4zODMzIDEuOTc0NDkgMTguMzQ4MyAyLjExNDYyIDE4LjI2MDdDNi41NjM4MSAxNS4wMjAxIDYuNzM4OTggMTAuNzgxMSA2LjczODk4IDEwLjYwNkM2LjczODk4IDEwLjIyMDYgNi40NDEyIDkuOTA1MzEgNi4wNTU4MyA5Ljg4NzhDNS42NzA0NyA5Ljg3MDI4IDUuMzU1MTcgMTAuMTg1NiA1LjMzNzY2IDEwLjU3MDlDNS4zMzc2NiAxMC43MTExIDUuMTYyNDkgMTQuMzAyIDEuMjkxMzUgMTcuMTIyMUMwLjk3NjA0OSAxNy4zNDk4IDAuOTA1OTgzIDE3Ljc4NzcgMS4xMzM3IDE4LjEwM1oiIGZpbGw9IiNBNjI2MjYiLz4KPC9zdmc+Cg=="
      alt=""/>
  </a>
  <a href="{{url_for('user_profile')}}"
    class="navbar-brand ms-3 d-flex align-items-center">
    <h5 class="text-muted ms-2 pt-2">خانه</h5>
    <i class="bi bi-house-fill fs-2 text-decoration-none text-color-brand"></i>
  </a>
</nav>
{% endblock %} 

{% block body %} 
<div class="row mt-5 d-flex justify-content-center align-items-center">
  
<div class="col-12 col-lg-6">
    <div class="d-flex flex-column  justify-content-center align-items-center">
      <img
        class="rounded-circle user_profile_img mt-2"
        src="{{user.image}}"
        alt=""/>
        <button
        class="btn btn-danger my-2"
        data-bs-toggle="modal"
        data-bs-target="#modal-upload">
        <span>تغییر تصویر حساب کاربری</span>
      </button>
    </div>
  </div>

  <div class="col-12 col-lg-6 border rounded ">
    <div class="info-user p-0 m-0">
        
      <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2">
        <div class="text-muted d-block justify-content-center align-items-center">
              <span>نام کاربری</span>
              <i class=" pe-1 bi bi-person-circle"></i>
        </div>
        <div class="text-muted">
          {% if user.username %}
              <span>{{user.username}}</span>
          {% else %}
              <span class="fs-8">مشکلی رخ داده است</span>
          {% endif %}
        </div>
      </div>

        <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2">
          <div class="text-muted d-block justify-content-center align-items-center">
              <span>تاریخ عضویت</span>
              <i class="pe-1 bi bi-calendar-check"></i>
          </div>
          <div class="text-muted">
            {% if user.join_date %}
            <span>{{user.join_date}}</span>
            {% else %}
            <span class="fs-8">مشکلی رخ داده است</span>
            {% endif  %}
          </div>

        </div>
          
        <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2 ">

          <div class="text-muted d-flex justify-content-between align-items-center">
            <span>ایمیل حساب کاربری</span>
            <i class="pe-1 bi bi-envelope-fill"></i>            
          </div>  
          <div class="text-muted">
            {% if user.email %}
              <span>{{user.email}}</span>
            {% else %}
              <span class="fs-8">مشکلی رخ داده است</span>
            {% endif %}
            </div>            

          </div>

        <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2">
          <div class="text-muted d-flex justify-content-between align-items-center">
            <span>شماره تماس</span>
            <i class="pe-1 bi bi-telephone-fill"></i>
          </div>  
            
          <div class="text-muted">
            {% if user.phone %}
            <span>{{user.phone}}</span>
            {% else %}
            <span class="">تنظیم نشده است</span>
            {% endif %}
         </div>
        
        </div>


        <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2 ">
          <div class="text-muted d-flex justify-content-between align-items-center">
            <span class="text-muted">استان</span>
            <i class="pe-1 bi bi-geo-alt-fill"></i>
          </div>  
          <div class="text-muted">
            {% if user.state %}
                <span class="text-muted">{{user.state}}</span>
            {% else %}
            <span class="">تنظیم نشده است</span>
            {% endif %}
          </div>
        </div>

        <div class="user_information d-flex justify-content-between align-items-center flex-row-reverse border-bottom px-1 py-2">
          <div class="text-muted d-flex justify-content-between align-items-center">
            <span class="text-muted">شهری</span>
            <i class="pe-1 bi bi-geo-alt-fill"></i>
          </div>  
          <div class="text-muted">
            {% if user.city %}
                <span class="text-muted">{{user.city}}</span>
            {% else %}
            <span class="">تنظیم نشده است</span>
            {% endif %}
          </div>
        </div>


    </div>
  </div>
</div>


<div class="modal fade" id="modal-upload">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
    <div class="modal-header" dir="rtl">
        <h4>آپلود عکس حساب کاربری</h4>
        <button id="loading-animation" type="button" disabled class=" btn bg-color-brand text-white">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </button>
    </div>

    <div class="modal-body">
        <div id="alert-container" class="">

        </div>

        <form action="{{url_for('user_profile')}}" id="form-upload-user" method="post" class="text-center">
          {{form.csrf_token()}}
          <div id="form-upload" class="rounded">
            <label
              id="input_area_file"
              for="input_file"
              style="width: 100% !important"
            >
              <div class="w-100 cursor-pointer">
                <div class="f-flex flex-column">
                  <i class="bi bi-cloud-arrow-up-fill upload-icon"></i>
                  <br />
                  <small class="text-muted" id="filename_placeholder"> فایل خود را انتخاب کنید </small>
                </div>
                {{form.file(id="input_file",enctype="multipart/form-data", class="form-control d-none",
                accept="image/*")}}
              </div>
            </label>
          </div>


          <div class="progress mt-2 w-100">
              <div class="text-center progress-bar progress-bar-striped progress-bar-animated bg-danger"
               role="progressbar" aria-label="Animated striped example"
               aria-valuemin="0"
               aria-valuemax="100"
               id="progress-bar-spinner" >
              <span id="progress-value"></span>
              </div>
          </div>


          <div
            class="w-100 my-2 d-flex justify-content-between align-items-center">
            <button id="cancell-btn" class="btn btn-primary" disabled type="button">
              لغو آپلود
            </button>
            {{form.submit(id="upload-btn",class="btn btn-primary",value="آپلود فایل ")}}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        

      </div>
    </div>
  </div>

</div>
<div class="fixed-bottom">
    <span class="text-muted p-2">نسخه دمو</span>
</div>


<script>
const input_file = document.querySelector("#input_file");
const input_form = document.querySelector("#form-upload-user");
const upload_btn = document.querySelector("#upload-btn");
const filename_placeholder = document.querySelector("#filename_placeholder");

const btn_cancell = document.querySelector("#cancell-btn");
btn_cancell.disabled=true;

const loading_animation = document.querySelector("#loading-animation");
loading_animation.classList.add("d-none");

let progress_bar = document.querySelector(".progress");
progress_bar.classList.add("d-none");

const alert = document.querySelector("#alert-container");
alert.classList.add("d-none");

function alert_show(message,categoty)
{
    if (alert.classList.contains("d-none"))
    {
        alert.classList.remove("d-none");
        console.log("deleted");
    }
    let alert_message = `
    <div class="alert alert-${category} d-flex show fade justify-content-between align-items-center">
        <span class="btn btn-close" data-bs-dismiss="alert"></span>
        <span class="message fs-8 p-1 text-start">${message}</span>
        </div>`;
        
        alert.innerHTML = alert_message;
}

let file_Selected = false;
upload_btn.disabled = true;

// cancell btn
btn_cancell.addEventListener("click",(e)=>{
            file_Selected = false;
            upload_btn.disabled = true;
            filename_placeholder.innerHTML = ` فایل خود را انتخاب کنید  `;
            if (!(progress_bar.classList.contains("d-none")))
            {
                progress_bar.classList.add("d-none");
            }
            if(!(loading_animation.classList.contains("d-none")))
            {
                loading_animation.classList.add("d-none");
            }  
  
            document.querySelector("#input_area_file").disabled=false;
            upload_btn.disabled=true;
            xhr = null;
            formdata = null;
            btn_cancell.disabled = true;
})


// input form
input_form.oninput = function(e){
    if(input_file.value &&  ((input_file.files[0].type).indexOf("image/") != -1))
    {
            file_Selected = true;
            btn_cancell.disabled = false;
            upload_btn.disabled = false;
            filename_placeholder.innerHTML = ` ${input_file.files[0].name }  : فایل  `;
            filename_placeholder.innerHTML += ` <br/>  ${(input_file.files[0].size / (1024 * 1024)).toFixed(2) } mb`;

            if (progress_bar.classList.contains("d-none"))
            {
                progress_bar.classList.remove("d-none");
                console.log(progress_bar.classList);
            }
            if(!(alert.classList.contains("d-none")))
            {
                alert.classList.add("d-none");
            }
            if(!(loading_animation.classList.contains("d-none")))
            {
                loading_animation.classList.remove("d-none");
            }
        }
        else
        {
            file_Selected = false;
            upload_btn.disabled = true;
            filename_placeholder.innerHTML = ` فایل خود را انتخاب کنید  `;
            if (!(progress_bar.classList.contains("d-none")))
            {
                progress_bar.classList.add("d-none");
            }
            if(!(loading_animation.classList.contains("d-none")))
            {
                loading_animation.classList.add("d-none");
            }
            const alert =`فایل انتخاب شده دارای فرمت نامعتبر است `;
            alert_show(message=alert,category="warning")
            e.preventDefault();
    }
    
};


// submit form
input_form.onsubmit = (event)=>{
    if (file_Selected)
    {
      // cancell user submit
      // for submiting via ajax
        event.preventDefault();    
    }
    else if(!file_Selected)
    {
        alert_show("فایلی انتخاب نشده است","danger");
        event.preventDefault();    
    }
}

// upload btn
upload_btn.addEventListener("click",function(e){
if (loading_animation.classList.contains("d-none"))
{
  loading_animation.classList.remove("d-none");
  console.log(loading_animation.classList);
}

let formdata  = new FormData();
formdata.append("file", input_file.files[0]);
formdata.append("csrf_token", document.querySelector('#csrf_token').value ); 
document.querySelector("#input_area_file").disabled=true;
upload_btn.disabled=true;

let xhr = new XMLHttpRequest();
xhr.upload.addEventListener("progress", function(e){

    let percentage = (e.loaded / e.total) * 100 ;
    if(Math.floor(percentage) === 100)
    {
      console.log("done");
      loading_animation.classList.add("d-none");
      loading_animation.classList.add("d-none");
      progress_bar.classList.add("d-none");
      document.querySelector("#input_area_file").disabled=false;
      upload_btn.disabled=false;
      alert_show(message="عکس با موفقیت آپدیت گردید",category="success")
    }
    document.querySelector("#progress-bar-spinner").setAttribute("style", "width:" + Math.round(percentage) + "%" );
    document.querySelector("#progress-bar-spinner").setAttribute("aria-valuenow", Math.round(percentage));
    document.querySelector("#progress-value").innerHTML=Math.floor(percentage) + "%";
    // console.log(percentage);
    // console.log("style", "width:" + Math.round(percentage) + "%" );
    // progress_bar.style.width = Math.round(percentage) + "%";
})

xhr.open("POST" ,location.href);
xhr.send(formdata);
xhr = null;
formdata = null;


})

</script>



{% endblock %}
